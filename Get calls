from airflow import DAG
from airflow.utils.dates import days_ago
from airflow.decorators import task
from airflow.operators.empty import EmptyOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.python import PythonOperator
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.python import PythonVirtualenvOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator, BranchPythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator, BranchPythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.python import PythonOperator, BranchPythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.decorators import dag
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.operators.trigger_dagrun import TriggerDagRunOperator
from airflow.operators.empty import EmptyOperator
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.python import PythonOperator
from airflow.operators.empty import EmptyOperator
from airflow.decorators import task
from airflow.triggers.date_time import DateTimeTrigger
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator
from airflow.decorators import dag
from airflow.triggers.date_time import DateTimeTrigger
from airflow.utils.timezone import parse as parse_time

from datetime import datetime
import pymongo

def get_task_time_from_mongo():
    # Replace with your MongoDB query logic
    mongo_uri = "mongodb://yourhost:port"
    client = pymongo.MongoClient(mongo_uri)
    db = client["your_db"]
    task = db.tasks.find_one({"status": "queued"})
    scheduled_time = task["scheduled_time"]  # ISO format: "2025-08-07T15:45:00"
    return scheduled_time

with DAG(
    dag_id="deferred_task_processor",
    start_date=days_ago(1),
    schedule_interval="@hourly",
    catchup=False,
    tags=["deferred", "mongodb"],
) as dag:

    start = EmptyOperator(task_id="start")

    get_scheduled_time = PythonOperator(
        task_id="get_scheduled_time",
        python_callable=get_task_time_from_mongo,
    )

    wait_until_time = EmptyOperator(
        task_id="wait_until_scheduled_time",
        trigger_rule="all_done",
        deferrable=True,
        trigger=DateTimeTrigger(
            moment=parse_time(get_task_time_from_mongo())
        ),
    )

    process_task = PythonOperator(
        task_id="process_task",
        python_callable=lambda: print("Task executed at scheduled time"),
    )

    end = EmptyOperator(task_id="end")

    start >> get_scheduled_time >> wait_until_time >> process_task >> end
